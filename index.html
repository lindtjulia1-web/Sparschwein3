<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>KGB Piggy Bank - Fixed Edition</title>
    <style>
        :root { --accent: #f9e076; --bg: #1e1e24; --panel: #2a2a32; --border: #3d3d45; }
        body { font-family: 'Segoe UI', sans-serif; background: #000; color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 380px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        h2 { color: var(--accent); font-size: 12px; text-transform: uppercase; margin: 15px 0 10px; border-left: 3px solid var(--accent); padding-left: 10px; }
        .card { background: rgba(0,0,0,0.2); border: 1px solid var(--border); padding: 12px; border-radius: 12px; margin-bottom: 15px; }
        label { display: block; font-size: 10px; color: #aaa; margin-top: 8px; text-transform: uppercase; }
        input, select, textarea { width: 100%; background: #111; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 6px; margin-top: 4px; box-sizing: border-box; font-size: 13px; }
        .btn { border: none; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        .btn-main { background: #ffb347; color: #000; }
        .btn-code { background: #77dd77; color: #000; }
        .preview { flex: 1; background: #0c0c0e; display: flex; align-items: center; justify-content: center; position: relative; }
        #device-wrapper { background: #000; border-radius: 30px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        iframe { width: 100%; height: 100%; border: none; }
        #code-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 1000; flex-direction: column; }
        #result-code { width: 80%; height: 60%; background: #111; color: #77dd77; padding: 15px; border-radius: 10px; font-family: monospace; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Экран</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <input type="number" id="width" value="800">
        <input type="number" id="height" value="450">
    </div>
    
    <h2>Тексты (RU/EN/DE)</h2>
    <label>Заголовок / Кнопка / Финал</label>
    <input type="text" id="start-title" value="Сокровища Пирата">
    <input type="text" id="start-btn-text" value="В БОЙ">
    <input type="text" id="end-text" value="ЗОЛОТО ВАШЕ!">
    <select id="lang"><option value="ru">Русский</option><option value="en">English</option><option value="de">Deutsch</option></select>

    <h2>Вопросы (Уровень 1)</h2>
    <div class="card">
        <label>Вопросы (по одному в строке)</label>
        <textarea id="lvl-1-q">Где золото?&#10;Сколько 2+2?</textarea>
        <label>Верные ответы</label>
        <textarea id="lvl-1-c">На острове&#10;4</textarea>
        <label>Неверные (через запятую)</label>
        <textarea id="lvl-1-w">В банке, В лесу&#10;5, 3</textarea>
    </div>

    <button class="btn btn-main" onclick="updatePreview()">ОБНОВИТЬ ПРЕВЬЮ</button>
    <button class="btn btn-code" onclick="getGeniallyCode()">ПОЛУЧИТЬ КОД</button>
</div>

<div class="preview">
    <div id="device-wrapper"><iframe id="ifr"></iframe></div>
</div>

<div id="code-modal">
    <textarea id="result-code" readonly></textarea>
    <button class="btn" style="width:200px" onclick="this.parentElement.style.display='none'">ЗАКРЫТЬ</button>
</div>

<script>
const GITHUB = "https://raw.githubusercontent.com/lindtjulia1-web/Sparschwein1/main/";

function buildInnerGame() {
    const cfg = {
        title: document.getElementById('start-title').value,
        btnTxt: document.getElementById('start-btn-text').value,
        endTxt: document.getElementById('end-text').value,
        lang: document.getElementById('lang').value,
        pigs: [GITHUB+"1.png", GITHUB+"2.png", GITHUB+"3.png", GITHUB+"4.png", GITHUB+"5.png", GITHUB+"6.png"],
        coin: GITHUB+"7.png",
        questions: document.getElementById('lvl-1-q').value.split('\n').map((q, i) => ({
            q: q.trim(),
            a: [
                (document.getElementById('lvl-1-c').value.split('\n')[i] || "???").trim(),
                ...document.getElementById('lvl-1-w').value.split('\n')[i].split(',').map(x => x.trim())
            ]
        }))
    };

    // Собираем HTML код игры
    return `<!DOCTYPE html><html><head><meta charset="UTF-8">
    <style>
        body { margin:0; height:100vh; background:#000; color:#fff; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; overflow:hidden; border:5px solid #f9e076; box-sizing:border-box; border-radius:30px; }
        .pig-box { position:relative; height:40vmin; margin:20px; }
        .pig { height:100%; transition:0.3s; z-index:5; position:relative; }
        .gold-glow { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:15vmin; height:15vmin; background:radial-gradient(circle, #f9e076 0%, transparent 70%); filter:blur(15px); opacity:0; transition: 1s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .btn-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; width:90%; }
        button { padding:15px; border:none; background:#f9e076; border-radius:10px; font-weight:bold; cursor:pointer; }
        .screen { position:absolute; inset:0; background:#000; z-index:100; display:flex; flex-direction:column; align-items:center; justify-content:center; }
    </style></head><body>
        <div id="start" class="screen"><h1>${cfg.title}</h1><button onclick="document.getElementById('start').remove()">${cfg.btnTxt}</button></div>
        <div id="score" style="font-size:5vmin; color:#f9e076">0</div>
        <div class="pig-box">
            <div id="glow" class="gold-glow"></div>
            <img id="pig" src="${cfg.pigs[0]}" class="pig">
        </div>
        <div id="q" style="margin-bottom:10px; font-weight:bold"></div>
        <div id="btns" class="btn-grid"></div>
    <script>
        const cfg = ${JSON.stringify(cfg)};
        let score = 0, cur = 0;
        function render() {
            if(cur >= cfg.questions.length) {
                document.getElementById('q').innerText = cfg.endTxt;
                document.getElementById('btns').innerHTML = '';
                document.getElementById('pig').src = cfg.pigs[5];
                return;
            }
            const data = cfg.questions[cur];
            document.getElementById('q').innerText = data.q;
            const bBox = document.getElementById('btns'); bBox.innerHTML = '';
            [...data.a].sort(()=>Math.random()-0.5).forEach(t => {
                const b = document.createElement('button'); b.innerText = t;
                b.onclick = () => {
                    if(t === data.a[0]) { 
                        score += 100; 
                        document.getElementById('glow').style.opacity = Math.min(score/500, 1);
                        document.getElementById('glow').style.transform = 'translate(-50%,-50%) scale('+(1+score/500)+')';
                    }
                    document.getElementById('score').innerText = score;
                    cur++; render();
                };
                bBox.appendChild(b);
            });
        }
        render();
    <\/script></body></html>`;
}

function updatePreview() {
    const w = document.getElementById('width').value;
    const h = document.getElementById('height').value;
    const wrap = document.getElementById('device-wrapper');
    wrap.style.width = w + 'px';
    wrap.style.height = h + 'px';
    const scale = Math.min((window.innerWidth - 420) / w, (window.innerHeight - 50) / h);
    wrap.style.transform = `scale(${scale})`;
    
    // ВАЖНО: заменяем закрывающий тег скрипта, чтобы он не обрывал строку
    const code = buildInnerGame().replace(/<\/script>/g, '<\\/script>');
    document.getElementById('ifr').srcdoc = code;
}

function getGeniallyCode() {
    const w = document.getElementById('width').value;
    const h = document.getElementById('height').value;
    const raw = buildInnerGame().replace(/<\/script>/g, '<\\/script>');
    const escaped = raw.replace(/"/g, '&quot;');
    document.getElementById('result-code').value = `<iframe width="${w}" height="${h}" srcdoc="${escaped}" frameborder="0" style="overflow:hidden;border-radius:30px;"></iframe>`;
    document.getElementById('code-modal').style.display = 'flex';
}

window.onload = updatePreview;
</script>
</body>
</html>
